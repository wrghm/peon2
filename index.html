<!-- index.html (JASNY – czytelny kontrast, bez duplikacji, spójne include) -->
<!DOCTYPE html>
<html lang="pl">
  <head>
    <base target="_top" />
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Wywiad psychiatryczny</title>

    <style>
      @import url("https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&display=swap");

      :root{
        --bg: #f5f7fb;
        --panel: #ffffff;
        --panel-ghost: rgba(255,255,255,.86);
        --panel-soft: rgba(15,23,42,.03);
        --card: #eef3ff;
        --card2: #ffffff;

        --text: #0f172a;
        --muted: rgba(15,23,42,.72);
        --muted2: rgba(15,23,42,.52);

        --line: rgba(15,23,42,.14);
        --line2: rgba(15,23,42,.10);
        --bd: var(--line);
        --bd2: var(--line2);

        --accent: #1d4ed8;
        --accent2: #0f766e;
        --glow1: rgba(29,78,216,.12);
        --glow2: rgba(15,118,110,.12);
        --focus-border: rgba(29,78,216,.45);
        --focus: rgba(29,78,216,.14);

        --ok: #16a34a;
        --warn: #d97706;
        --bad: #dc2626;

        --shadow: 0 18px 50px rgba(15,23,42,.12);
        --shadow-soft: 0 10px 24px rgba(15,23,42,.08);
        --radius: 16px;
        --max: 1180px;
        --font: "Manrope", "Segoe UI", "Segoe UI Emoji", "Segoe UI Symbol", sans-serif;
      }

      html[data-theme="dark"]{
        --bg: #0b1220;
        --panel: #111827;
        --panel-ghost: rgba(17,24,39,.86);
        --panel-soft: rgba(148,163,184,.08);
        --card: #0f172a;
        --card2: #111827;

        --text: #e5e7eb;
        --muted: rgba(229,231,235,.68);
        --muted2: rgba(229,231,235,.48);

        --line: rgba(148,163,184,.22);
        --line2: rgba(148,163,184,.14);
        --bd: var(--line);
        --bd2: var(--line2);

        --accent: #60a5fa;
        --accent2: #34d399;
        --glow1: rgba(96,165,250,.14);
        --glow2: rgba(52,211,153,.12);
        --focus-border: rgba(96,165,250,.55);
        --focus: rgba(96,165,250,.18);

        --ok: #22c55e;
        --warn: #f59e0b;
        --bad: #f87171;

        --shadow: 0 20px 60px rgba(2,6,23,.45);
        --shadow-soft: 0 12px 32px rgba(2,6,23,.35);
      }

      *{ box-sizing:border-box }
      html, body{ height:100% }
      body{
        margin:0;
        font-family: var(--font);
        color: var(--text);
        line-height: 1.45;
        background:
          radial-gradient(900px 520px at 12% -10%, var(--glow1) 0%, rgba(0,0,0,0) 60%),
          radial-gradient(760px 520px at 100% 0%, var(--glow2) 0%, rgba(0,0,0,0) 60%),
          var(--bg);
      }

      .wrap{ min-height:100%; display:flex; flex-direction:column }

      .topbar{
        position: sticky;
        top: 0;
        z-index: 50;
        background: var(--panel-ghost);
        backdrop-filter: blur(10px);
        border-bottom: 1px solid var(--line);
      }
      .topbar-inner{
        max-width: var(--max);
        margin: 0 auto;
        padding: 12px 14px;
        display:flex;
        align-items:center;
        gap: 10px;
      }
      .brand{
        display:flex;
        align-items:flex-start;
        gap: 10px;
        min-width: 240px;
      }
      .brand .logo{
        width: 34px;
        height: 34px;
        border-radius: 10px;
        background: linear-gradient(135deg, var(--accent), var(--accent2));
        box-shadow: 0 10px 26px rgba(29,78,216,.18);
      }
      .brand h1{ margin:0; font-size: 15px; letter-spacing:.2px; line-height:1.15 }
      .brand .sub{ margin-top: 2px; font-size: 12px; color: var(--muted2) }

      .pill{
        display:inline-flex;
        align-items:center;
        gap:8px;
        padding: 6px 10px;
        border-radius: 999px;
        border: 1px solid var(--line);
        background: var(--panel);
        color: var(--muted);
        font-size: 12px;
        white-space: nowrap;
      }
      .dot{ width:8px;height:8px;border-radius:999px; background: var(--ok); box-shadow: 0 0 0 4px rgba(5,150,105,.10) }
      .spacer{ flex:1 }

      .btn{
        appearance:none;
        border: 1px solid var(--line);
        background: var(--panel);
        color: var(--text);
        padding: 9px 10px;
        border-radius: 12px;
        cursor:pointer;
        font-size: 13px;
        display:inline-flex;
        align-items:center;
        justify-content:center;
        gap: 8px;
        transition: transform .08s ease, background .12s ease, border-color .12s ease, box-shadow .12s ease;
        user-select:none;
      }
      .btn:hover{
        background: var(--panel);
        border-color: rgba(29,78,216,.28);
        box-shadow: var(--shadow-soft);
      }
      .btn:active{ transform: translateY(1px) }
      .btn.primary{
        border-color: rgba(29,78,216,.35);
        background: linear-gradient(135deg, rgba(29,78,216,.14), rgba(15,118,110,.10));
      }
      .btn.ghost{ background: transparent }

      .layout{
        width: 100%;
        max-width: var(--max);
        margin: 0 auto;
        padding: 16px 14px 26px;
        display:grid;
        grid-template-columns: 330px 1fr;
        gap: 14px;
      }

      .sidebar{
        position: sticky;
        top: 72px;
        align-self:start;
        height: calc(100vh - 92px);
        overflow:auto;
        border-radius: var(--radius);
        border: 1px solid var(--line);
        background: var(--panel-ghost);
        box-shadow: var(--shadow);
      }
      .side-inner{ padding: 12px }

      .section-title{
        font-size: 12px;
        color: var(--muted2);
        letter-spacing: .12em;
        text-transform: uppercase;
        margin: 10px 0 8px;
      }

      .card{
        border: 1px solid var(--line);
        border-radius: var(--radius);
        background: var(--panel);
        box-shadow: var(--shadow-soft);
      }
      .card.pad{ padding: 12px }

      .grid2{ display:grid; grid-template-columns: 1fr 1fr; gap: 10px }
      label{ font-size: 12px; color: var(--muted2); display:block; margin-bottom:6px }

      select, input[type="text"], textarea{
        width: 100%;
        border: 1px solid var(--line);
        background: var(--panel);
        color: var(--text);
        border-radius: 12px;
        padding: 9px 10px;
        font-size: 13px;
        outline: none;
        transition: border-color .12s ease, box-shadow .12s ease, background .12s ease;
      }
      select:focus, input[type="text"]:focus, textarea:focus{
        border-color: var(--focus-border);
        box-shadow: 0 0 0 3px var(--focus);
      }
      input[disabled]{
        background: var(--panel-soft);
        color: var(--muted2);
      }
      textarea{ min-height: 120px; resize: vertical; line-height: 1.35 }
      textarea[rows="2"]{ min-height: 64px }
      textarea[rows="3"]{ min-height: 80px }
      textarea[rows="8"]{ min-height: 180px }
      textarea.big[rows="2"]{ min-height: 72px }

      input[type="text"][data-key*=".date"],
      input[type="text"][data-key*=".time"],
      input[type="text"]#patientId,
      input[type="text"]#lastSaved{
        width: 16ch;
        max-width: 220px;
      }
      textarea::placeholder, input::placeholder{ color: var(--muted2) }

      .side-actions{ display:grid; grid-template-columns: 1fr 1fr; gap: 10px }
      .side-actions .btn{ width:100% }
      .hint{ margin-top: 8px; font-size: 12px; color: var(--muted); line-height: 1.35 }

      .main{
        border-radius: var(--radius);
        border: 1px solid var(--line);
        background: var(--panel-ghost);
        box-shadow: var(--shadow);
        overflow:hidden;
      }
      .main-head{
        padding: 14px 14px 12px;
        border-bottom: 1px solid var(--line);
        display:flex;
        align-items:center;
        gap: 10px;
        background: var(--panel-ghost);
      }
      .main-head h2{ margin:0; font-size: 14px; letter-spacing:.2px }
      .main-head .meta{ color: var(--muted2); font-size: 12px }
      .main-body{ padding: 14px }

      details.acc{
        border: 1px solid var(--line);
        border-radius: var(--radius);
        background: var(--panel);
        margin-bottom: 12px;
        overflow:hidden;
        box-shadow: var(--shadow-soft);
      }
      details.acc[open]{ background: var(--panel) }
      summary.acc-head{
        cursor:pointer;
        padding: 12px 12px;
        list-style:none;
        display:flex;
        align-items:center;
        gap: 10px;
        user-select:none;
        background: var(--panel-ghost);
      }
      summary.acc-head::-webkit-details-marker{ display:none }
      details.acc[open] summary.acc-head{ border-bottom: 1px solid var(--line2) }
      .acc-title{ font-weight: 700; font-size: 13px; letter-spacing: .2px }
      .acc-sub{ margin-left:auto; color: var(--muted2); font-size: 12px }
      .acc-body{ padding: 12px }

      .info{
        border: 1px dashed var(--line);
        border-radius: 12px;
        padding: 10px;
        color: var(--muted);
        font-size: 12px;
        line-height:1.35;
        background: var(--panel-soft);
      }

      .toast{
        position: fixed;
        right: 14px;
        bottom: 14px;
        z-index: 60;
        max-width: 420px;
        display:none;
        padding: 10px 12px;
        border-radius: 14px;
        border: 1px solid var(--line);
        background: var(--panel);
        box-shadow: var(--shadow);
        color: var(--text);
        font-size: 13px;
      }
      .toast.show{ display:block }
      .toast small{ color: var(--muted2) }

      @keyframes floatIn{
        from{ opacity:0; transform: translateY(6px); }
        to{ opacity:1; transform: translateY(0); }
      }
      .card, .sidebar, .main, details.acc{ animation: floatIn .35s ease both }
      @media (prefers-reduced-motion: reduce){
        *{ animation: none !important; transition: none !important }
      }

      body.sidebar-collapsed .layout{ grid-template-columns: 1fr }
      body.sidebar-collapsed .sidebar{ display:none }

      [data-show-modes] { display:none }
      body[data-mode="Poradnia"] [data-show-modes~="Poradnia"],
      body[data-mode="IzbaPrzyjec"] [data-show-modes~="IzbaPrzyjec"],
      body[data-mode="OddzialDzienny"] [data-show-modes~="OddzialDzienny"],
      body[data-mode="OddzialZamkniety"] [data-show-modes~="OddzialZamkniety"],
      body[data-mode="Obserwacja"] [data-show-modes~="Obserwacja"],
      body[data-mode="Wypis"] [data-show-modes~="Wypis"],
      body[data-mode="Wiedza"] [data-show-modes~="Wiedza"]{
        display:block;
      }

      @media (max-width: 980px){
        .layout{ grid-template-columns: 1fr }
        .sidebar{ position: relative; top: 0; height: auto }
      }
    </style>
  </head>

  <body data-mode="OddzialDzienny">
    <div class="wrap">
      <header class="topbar">
        <div class="topbar-inner">
          <div class="brand">
            <div class="logo" aria-hidden="true"></div>
            <div>
              <h1>Wywiad psychiatryczny</h1>
              <div class="sub" id="modeLabelTop">Tryb: Oddział dzienny</div>
            </div>
          </div>

          <div class="pill" title="Stan autosave i sesji">
            <span class="dot" id="autosaveDot"></span>
            <span id="autosaveText">Autosave: włączony</span>
          </div>

          <div class="spacer"></div>

          <button class="btn ghost" id="btnToggleSidebar" type="button" title="Zwiń lub rozwiń panel">☰ Panel</button>
          <button type="button" id="btnTheme" class="btn">Kolor</button>
          <button class="btn primary" id="btnSaveDriveTop" type="button" title="Zapis do Drive">Zapisz na Drive</button>
        </div>
      </header>

      <div class="layout">
        <aside class="sidebar" id="sidebarRoot" aria-label="Panel sterowania">
          <div class="side-inner">
            <div class="card pad">
              <div class="grid2">
                <div>
                  <label for="modeSelect">Tryb pracy</label>
                  <select id="modeSelect">
                    <option value="Poradnia">Poradnia</option>
                    <option value="IzbaPrzyjec">Izba przyjęć</option>
                    <option value="OddzialDzienny" selected>Oddział dzienny</option>
                    <option value="OddzialZamkniety">Oddział zamknięty</option>
                    <option value="Obserwacja">Obserwacja</option>
                    <option value="Wypis">Wypis</option>
                    <option value="Wiedza">Wiedza</option>
                  </select>
                </div>
                <div>
                  <label for="patientId">ID pacjenta lub inicjały</label>
                  <input id="patientId" type="text" placeholder="Np. AB, 12345, NN" />
                </div>
              </div>

              <div style="height:10px"></div>

              <div class="grid2">
                <div>
                  <label for="riskSelect">Ryzyko S i H</label>
                  <select id="riskSelect">
                    <option value="Brak">Brak myśli S i H</option>
                    <option value="Mysli">Myśli bez planu</option>
                    <option value="Plan">Plan lub zamiar</option>
                    <option value="Wysokie">Wysokie ryzyko</option>
                  </select>
                </div>

                <div>
                  <label for="lastSaved">Ostatnia zmiana</label>
                  <input id="lastSaved" type="text" placeholder="brak" disabled />
                </div>
              </div>

              <div class="hint">
                Placeholdery są szare i znikają po rozpoczęciu pisania.
              </div>
            </div>

            <div class="section-title">Akcje</div>
            <div class="card pad">
              <div class="side-actions">
                <button class="btn" id="btnRestore" type="button">Przywróć</button>
                <button class="btn" id="btnClear" type="button">Wyczyść</button>
                <button class="btn" id="btnDownloadTxt" type="button">Pobierz TXT</button>
                <button class="btn" id="btnPrint" type="button">Druk</button>
                <button class="btn" id="btnCoJeszcze" type="button">Co jeszcze</button>
                <button class="btn primary" id="btnSaveDrive" type="button">Zapisz na Drive</button>
              </div>
              <div class="hint">Skrót: Ctrl/Cmd + S zapis do Drive</div>
            </div>

            <div class="section-title">Moduły</div>
            <div class="card pad" id="modulesCard" data-show-modes="Poradnia IzbaPrzyjec OddzialDzienny OddzialZamkniety">
              <div class="info">
                Moduły dodajesz bez utraty danych. Po wykryciu alkoholu lub narkotyków system może dodać SUD automatycznie.
              </div>
              <div style="height:10px"></div>
              <?!= include('ModulesHost'); ?>
            </div>

            <div class="card pad" id="observationToolsCard" data-show-modes="Obserwacja">
              <div class="info">Tryb Obserwacja ma własne narzędzia. Tekst trafia do edytowalnych pól.</div>
              <div style="height:10px"></div>
              <button class="btn" id="btnObsRandomImprove" type="button">Losowa obserwacja: poprawa</button>
              <div style="height:8px"></div>
              <button class="btn" id="btnObsRandomSame" type="button">Losowa obserwacja: bez zmian</button>
              <div style="height:8px"></div>
              <button class="btn" id="btnObsRandomWorse" type="button">Losowa obserwacja: pogorszenie</button>
            </div>
          </div>
        </aside>

        <main class="main" id="mainRoot" aria-label="Treść formularza">
          <div class="main-head">
            <h2 id="mainTitle">Wywiad i dokumentacja</h2>
            <div class="meta" id="mainMeta">Sekcje zwijane, jasny kontrast</div>
            <div class="spacer"></div>
            <div class="pill"><span class="dot"></span><span id="modeLabel">Oddział dzienny</span></div>
          </div>

          <div class="main-body">
            <div data-show-modes="Poradnia IzbaPrzyjec OddzialDzienny OddzialZamkniety">
              <details class="acc" open>
                <summary class="acc-head">
                  <span class="acc-title">Wywiad podstawowy</span>
                  <span class="acc-sub">pytania jako placeholdery</span>
                </summary>
                <div class="acc-body">
                  <?!= include('BaseInterview'); ?>
                </div>
              </details>

              <details class="acc">
                <summary class="acc-head">
                  <span class="acc-title">Moduły dodatkowe</span>
                  <span class="acc-sub">wpinane bez utraty danych</span>
                </summary>
                <div class="acc-body">
                  <div id="modulesMount"></div>
                </div>
              </details>
            </div>

            <div data-show-modes="Obserwacja">
              <?!= include('module_observation'); ?>
            </div>

            <div data-show-modes="Wypis">
              <?!= include('mode_discharge'); ?>
            </div>

            <div data-show-modes="Wiedza">
              <?!= include('mode_knowledge'); ?>
            </div>
          </div>
        </main>
      </div>

      <div class="toast" id="toast" role="status" aria-live="polite"></div>

      <!-- CORE JS/REGISTRY -->
      <?!= include('ModulesRegistry'); ?>
      <?!= include('Module_SUD'); ?>
      <?!= include('Module_MSE'); ?>
      <?!= include('Module_Scales'); ?>
      <?!= include('Module_Clinical'); ?>
      <?!= include('Engine'); ?>
      <script>
        function setTheme(t) {
          document.documentElement.setAttribute("data-theme", t)
          localStorage.setItem("PEON2_THEME", t)
        }

        function toggleTheme() {
          const cur = document.documentElement.getAttribute("data-theme") || "light"
          setTheme(cur === "dark" ? "light" : "dark")
        }

        ;(() => {
          const saved = localStorage.getItem("PEON2_THEME")
          setTheme(saved || "light")

          const btn = document.getElementById("btnTheme")
          if (btn) btn.addEventListener("click", toggleTheme)
        })()
      </script>
    </div>

    <!-- PATCHES (single include block at end of body) -->
    <?!= include('Patcher'); ?>
    <?!= includeOptional('PATCH_02_THEME'); ?>

    
</body>
</html>
