<!-- mode_discharge.html -->
<style>
  .disWrap{ display:grid; gap:12px }
  .disHead{
    display:flex;
    justify-content:space-between;
    align-items:flex-start;
    gap:10px;
    flex-wrap:wrap;
  }
  .disTitle{ font-weight:800; font-size:14px; letter-spacing:.2px }
  .disSub{ font-size:12px; color: var(--muted) }
  .disGrid2{ display:grid; grid-template-columns:1fr 1fr; gap:12px }
  .disGrid3{ display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px }
  .disFlags{
    display:flex;
    flex-wrap:wrap;
    gap:8px;
  }
  .disFlag{
    display:inline-flex;
    align-items:center;
    gap:8px;
    padding:6px 10px;
    border-radius:999px;
    border:1px solid var(--line);
    background: rgba(255,255,255,.65);
    font-size:12px;
    user-select:none;
  }
  .disFlag input{ width:16px; height:16px }
  .disActions{ display:flex; flex-wrap:wrap; gap:8px }
  .disOut{ min-height:220px }
  @media(max-width:980px){
    .disGrid2, .disGrid3{ grid-template-columns:1fr }
  }
</style>

<div id="dischargeRoot" class="disWrap">
  <div class="card pad">
    <div class="disHead">
      <div>
        <div class="disTitle">Wypis</div>
        <div class="disSub">Generator tekstu wypisu. Wszystkie pola pozostaja edytowalne.</div>
      </div>
      <div class="disActions">
        <button type="button" class="btn ghost" id="disBtnDate">Wstaw dzisiejsza date</button>
      </div>
    </div>

    <div class="disGrid3">
      <div class="field">
        <label>Data wypisu</label>
        <input type="text" data-key="dis.meta.date" placeholder="np. 2026-01-31" />
      </div>
      <div class="field">
        <label>Oddzial</label>
        <input type="text" data-key="dis.meta.ward" placeholder="np. Oddzial X / IP / Dzienny" />
      </div>
      <div class="field">
        <label>Haslowy powod przyjecia</label>
        <input type="text" data-key="dis.meta.admission_reason" placeholder="1-2 zdania lub slowa kluczowe" />
      </div>
    </div>

    <div class="disGrid2">
      <div class="field">
        <label>Tryb i powod wypisu</label>
        <textarea data-key="dis.meta.discharge_reason" placeholder="np. wypis planowy / na zadanie / dyscyplinarny. Okolicznosci i uzasadnienie"></textarea>
      </div>
      <div class="field">
        <label>Rozpoznanie robocze i problem wiodacy</label>
        <textarea data-key="dis.meta.diagnosis_working" placeholder="Pisz klinicznie, bez kodow. Objawy osiowe i tlo."></textarea>
      </div>
    </div>

    <div class="disGrid2">
      <div class="field">
        <label>Przebieg hospitalizacji i interwencje</label>
        <textarea data-key="dis.meta.course" placeholder="Najwazniejsze: stabilizacja, obserwacje, zmiany leczenia, psychoedukacja, konsultacje"></textarea>
      </div>
      <div class="field">
        <label>Diagnostyka i badania</label>
        <textarea data-key="dis.meta.tests" placeholder="Badania laboratoryjne, EKG, konsultacje, wnioski istotne klinicznie"></textarea>
      </div>
    </div>

    <div class="disGrid2">
      <div class="field">
        <label>Stan psychiczny w dniu wypisu</label>
        <textarea data-key="dis.meta.mse_summary" placeholder="Krotki MSE: kontakt, tok, nastroj, wytworcze, ryzyko, wglad"></textarea>
      </div>
      <div class="field">
        <label>Funkcjonowanie i ocena kliniczna</label>
        <textarea data-key="dis.meta.functioning" placeholder="Funkcjonowanie w oddziale, wspolpraca, samoobsluga, wnioski"></textarea>
      </div>
    </div>

    <div class="disGrid2">
      <div class="field">
        <label>Ocena ryzyka i bezpieczenstwo</label>
        <textarea data-key="dis.meta.risk_summary" placeholder="Mysli S i H, zachowania autoagresywne, czynniki chroniace, plan bezpieczenstwa"></textarea>
      </div>
      <div class="field">
        <label>Kontynuacja leczenia i kontrole</label>
        <textarea data-key="dis.meta.followup" placeholder="PZP, psychoterapia, terminy kontroli, kontakt kryzysowy, plan 24-72h"></textarea>
      </div>
    </div>

    <div class="disGrid2">
      <div class="field">
        <label>Farmakoterapia przy wypisie</label>
        <textarea data-key="dis.meta.meds" placeholder="Kazdy lek w osobnej linii. Dawka, pora, tolerancja."></textarea>
      </div>
      <div class="field">
        <label>Zalecenia</label>
        <textarea data-key="dis.meta.instructions" placeholder="Psychoedukacja, higiena snu, unikanie substancji, wskazania do pilnej konsultacji"></textarea>
      </div>
    </div>

    <div class="disFlags">
      <label class="disFlag"><input type="checkbox" data-key="dis.flags.include_headers" checked /> <span>Naglowki</span></label>
      <label class="disFlag"><input type="checkbox" data-key="dis.flags.include_mse" checked /> <span>MSE</span></label>
      <label class="disFlag"><input type="checkbox" data-key="dis.flags.include_tests" checked /> <span>Badania</span></label>
      <label class="disFlag"><input type="checkbox" data-key="dis.flags.include_risk" checked /> <span>Ryzyko</span></label>
      <label class="disFlag"><input type="checkbox" data-key="dis.flags.include_meds" checked /> <span>Leki</span></label>
      <label class="disFlag"><input type="checkbox" data-key="dis.flags.include_instructions" checked /> <span>Zalecenia</span></label>
    </div>

    <div class="disActions">
      <button type="button" class="btn" id="disBtnGen">Zloz tekst wypisu</button>
      <button type="button" class="btn" id="disBtnAppend">Dopisz jako kolejny blok</button>
      <button type="button" class="btn ghost" id="disBtnClear">Wyczysc tekst</button>
    </div>

    <div class="field">
      <label>Tekst wypisu (edytowalny)</label>
      <textarea class="disOut" data-key="dis.out.text" placeholder="Tu pojawi sie zlozony tekst wypisu. Mozesz go dalej edytowac."></textarea>
    </div>
  </div>
</div>

<script>
(() => {
  const root = document.getElementById("dischargeRoot");
  if (!root) return;
  const q = (sel) => root.querySelector(sel);
  const readText = (key) => {
    const el = q(`[data-key="${key}"]`);
    return el ? String(el.value || "").trim() : "";
  };
  const readBool = (key) => {
    const el = q(`[data-key="${key}"]`);
    return !!(el && el.checked);
  };
  const setText = (key, val) => {
    const el = q(`[data-key="${key}"]`);
    if (el) el.value = val || "";
  };
  const mark = () => { if (window.markEdited) window.markEdited(); };
  const v = (x) => String(x || "").trim();

  const buildDischargeText = () => {
    const parts = [];
    const includeHeaders = readBool("dis.flags.include_headers");
    const includeMse = readBool("dis.flags.include_mse");
    const includeTests = readBool("dis.flags.include_tests");
    const includeMeds = readBool("dis.flags.include_meds");
    const includeInstr = readBool("dis.flags.include_instructions");
    const includeRisk = readBool("dis.flags.include_risk");

    if (includeHeaders) {
      const hdr = [];
      const date = readText("dis.meta.date");
      const ward = readText("dis.meta.ward");
      if (v(date)) hdr.push(`Data wypisu: ${v(date)}`);
      if (v(ward)) hdr.push(`Oddzial: ${v(ward)}`);
      if (hdr.length) parts.push(hdr.join("\n"));
    }

    const admission = readText("dis.meta.admission_reason");
    if (v(admission)) parts.push(`Powod przyjecia\n${v(admission)}`);

    const discharge = readText("dis.meta.discharge_reason");
    if (v(discharge)) parts.push(`Tryb i powod wypisu\n${v(discharge)}`);

    const dx = readText("dis.meta.diagnosis_working");
    if (v(dx)) parts.push(`Rozpoznanie robocze i problem wiodacy\n${v(dx)}`);

    const course = readText("dis.meta.course");
    if (v(course)) parts.push(`Przebieg hospitalizacji i interwencje\n${v(course)}`);

    const tests = readText("dis.meta.tests");
    if (includeTests && v(tests)) parts.push(`Diagnostyka i badania\n${v(tests)}`);

    const mse = readText("dis.meta.mse_summary");
    if (includeMse && v(mse)) parts.push(`Stan psychiczny w dniu wypisu\n${v(mse)}`);

    const func = readText("dis.meta.functioning");
    if (v(func)) parts.push(`Funkcjonowanie i ocena kliniczna\n${v(func)}`);

    const risk = readText("dis.meta.risk_summary");
    if (includeRisk && v(risk)) parts.push(`Ocena ryzyka i bezpieczenstwo\n${v(risk)}`);

    const meds = readText("dis.meta.meds");
    if (includeMeds && v(meds)) parts.push(`Farmakoterapia przy wypisie\n${v(meds)}`);

    const follow = readText("dis.meta.followup");
    if (v(follow)) parts.push(`Kontynuacja leczenia i kontrole\n${v(follow)}`);

    const instr = readText("dis.meta.instructions");
    if (includeInstr && v(instr)) parts.push(`Zalecenia\n${v(instr)}`);

    return parts.filter(Boolean).join("\n\n");
  };

  const out = q('[data-key="dis.out.text"]');
  if (!out) return;

  q("#disBtnGen")?.addEventListener("click", () => {
    out.value = buildDischargeText();
    mark();
  });

  q("#disBtnAppend")?.addEventListener("click", () => {
    const txt = buildDischargeText();
    const cur = v(out.value);
    out.value = cur ? `${cur}\n\n${txt}` : txt;
    mark();
  });

  q("#disBtnClear")?.addEventListener("click", () => {
    out.value = "";
    mark();
  });

  q("#disBtnDate")?.addEventListener("click", () => {
    const d = new Date();
    const pad = (n) => String(n).padStart(2, "0");
    const iso = `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}`;
    setText("dis.meta.date", iso);
    mark();
  });
})();
</script>
