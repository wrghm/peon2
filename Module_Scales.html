<!-- Module_Scales.html -->
<template id="tpl-module-scales">
  <section class="card">
    <header class="card-h">
      <h2>Skale</h2>
      <p class="muted">Wynik liczy się automatycznie</p>
    </header>

    <div class="scale-toggles" data-scale-toggles></div>

    <div class="grid2">
      <div class="scale" data-scale="phq9">
        <h3>PHQ-9</h3>
        <div class="muted small">0–27</div>
        <div class="items" data-items="phq9"></div>
        <div class="result">
          <div><strong>Suma</strong> <span data-total="phq9">0</span></div>
          <div class="muted" data-note="phq9"></div>
        </div>
      </div>

      <div class="scale" data-scale="gad7">
        <h3>GAD-7</h3>
        <div class="muted small">0–21</div>
        <div class="items" data-items="gad7"></div>
        <div class="result">
          <div><strong>Suma</strong> <span data-total="gad7">0</span></div>
          <div class="muted" data-note="gad7"></div>
        </div>
      </div>

      <div class="scale" data-scale="audit">
        <h3>AUDIT</h3>
        <div class="muted small">0–40</div>
        <div class="items" data-items="audit"></div>
        <div class="result">
          <div><strong>Suma</strong> <span data-total="audit">0</span></div>
          <div class="muted" data-note="audit"></div>
        </div>
      </div>

      <div class="scale" data-scale="dast10">
        <h3>DAST-10</h3>
        <div class="muted small">0–10</div>
        <div class="items" data-items="dast10"></div>
        <div class="result">
          <div><strong>Suma</strong> <span data-total="dast10">0</span></div>
          <div class="muted" data-note="dast10"></div>
        </div>
      </div>
    </div>
  </section>

  <style>
    .grid2 { display:grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 14px }
    @media (max-width: 980px) { .grid2 { grid-template-columns: 1fr } }
    .scale { border: 1px solid var(--bd); border-radius: 14px; padding: 12px; background: var(--panel) }
    .items { display:flex; flex-direction: column; gap: 10px; margin-top: 10px }
    .row { display:grid; grid-template-columns: 1fr auto; gap: 10px; align-items: center; border-top: 1px dashed var(--bd2); padding-top: 10px }
    .row:first-child { border-top: 0; padding-top: 0 }
    .opts { display:flex; gap: 8px; flex-wrap: wrap; justify-content: flex-end }
    .pill { display:inline-flex; gap: 6px; align-items:center; border: 1px solid var(--bd); border-radius: 999px; padding: 6px 10px; background: var(--bg); cursor: pointer; user-select: none }
    .pill input { accent-color: var(--accent) }
    .result { margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--bd2) }
    .small { font-size: 12px }
    .scale-toggles { display:flex; flex-wrap: wrap; gap: 8px; margin: 6px 0 14px }
    .toggle-btn{
      appearance: none;
      border: 1px solid var(--bd);
      background: var(--panel);
      color: var(--text);
      border-radius: 999px;
      padding: 6px 12px;
      font-size: 12px;
      cursor: pointer;
      user-select: none;
    }
    .toggle-btn.is-off{
      opacity: .55;
      text-decoration: line-through;
    }
  </style>
</template>

<script>
(() => {
  const VIS_KEY = "PEON2_SCALES_VIS"

  const SCALE_DEF = {
    phq9: {
      title: "PHQ-9",
      items: [
        "Anhedonia",
        "Obniżony nastrój",
        "Sen",
        "Zmęczenie",
        "Apetyt",
        "Poczucie winy lub bezwartościowości",
        "Koncentracja",
        "Spowolnienie lub pobudzenie",
        "Myśli samobójcze"
      ],
      type: "likert4",
      note(total) {
        if (total <= 4) return "Minimalne"
        if (total <= 9) return "Łagodne"
        if (total <= 14) return "Umiarkowane"
        if (total <= 19) return "Umiarkowanie ciężkie"
        return "Ciężkie"
      }
    },
    gad7: {
      title: "GAD-7",
      items: [
        "Nerwowość lub napięcie",
        "Brak kontroli zamartwiania",
        "Nadmierne zamartwianie",
        "Trudność w relaksacji",
        "Niepokój ruchowy",
        "Łatwe irytowanie",
        "Lęk antycypacyjny"
      ],
      type: "likert4",
      note(total) {
        if (total <= 4) return "Minimalne"
        if (total <= 9) return "Łagodne"
        if (total <= 14) return "Umiarkowane"
        return "Ciężkie"
      }
    },
    audit: {
      title: "AUDIT",
      items: [
        "Częstość picia",
        "Ilość standardowych porcji",
        "Częstość upijania",
        "Utrata kontroli",
        "Zaniedbywanie obowiązków",
        "Poranne klinowanie",
        "Wyrzuty sumienia",
        "Luki pamięci",
        "Urazy związane z alkoholem",
        "Sugestie otoczenia"
      ],
      type: "audit",
      note(total) {
        if (total <= 7) return "Niskie ryzyko"
        if (total <= 15) return "Ryzykowne"
        if (total <= 19) return "Szkodliwe"
        return "Prawdopodobne uzależnienie"
      }
    },
    dast10: {
      title: "DAST-10",
      items: [
        "Używanie niezgodne z zaleceniem",
        "Jednoczesne używanie wielu substancji",
        "Nieumiejętność przerwania",
        "Głód lub przymus",
        "Konflikty rodzinne",
        "Zaniedbywanie pracy lub szkoły",
        "Problemy prawne",
        "Objawy odstawienne",
        "Problemy zdrowotne",
        "Żal po użyciu"
      ],
      type: "yesno",
      note(total) {
        if (total === 0) return "Brak problemu"
        if (total <= 2) return "Niskie"
        if (total <= 5) return "Umiarkowane"
        if (total <= 8) return "Znaczne"
        return "Bardzo znaczne"
      }
    }
  }

  function buildLikert4(name, idx) {
    const opts = [
      { v: 0, t: "0" },
      { v: 1, t: "1" },
      { v: 2, t: "2" },
      { v: 3, t: "3" }
    ]
    const wrap = document.createElement("div")
    wrap.className = "opts"
    for (const o of opts) {
      const lab = document.createElement("label")
      lab.className = "pill"
      const inp = document.createElement("input")
      inp.type = "radio"
      inp.name = `${name}_${idx}`
      inp.value = String(o.v)
      lab.appendChild(inp)
      const span = document.createElement("span")
      span.textContent = o.t
      lab.appendChild(span)
      wrap.appendChild(lab)
    }
    return wrap
  }

  function buildYesNo(name, idx) {
    const wrap = document.createElement("div")
    wrap.className = "opts"
    for (const o of [{ v: 0, t: "Nie" }, { v: 1, t: "Tak" }]) {
      const lab = document.createElement("label")
      lab.className = "pill"
      const inp = document.createElement("input")
      inp.type = "radio"
      inp.name = `${name}_${idx}`
      inp.value = String(o.v)
      lab.appendChild(inp)
      const span = document.createElement("span")
      span.textContent = o.t
      lab.appendChild(span)
      wrap.appendChild(lab)
    }
    return wrap
  }

  function buildAudit(name, idx) {
    return buildLikert4(name, idx)
  }

  function renderScale(container, key) {
    const def = SCALE_DEF[key]
    const itemsHost = container.querySelector(`[data-items="${key}"]`)
    if (!itemsHost) return
    itemsHost.innerHTML = ""

    def.items.forEach((label, idx) => {
      const row = document.createElement("div")
      row.className = "row"

      const left = document.createElement("div")
      left.textContent = label

      const right = def.type === "yesno"
        ? buildYesNo(key, idx)
        : def.type === "audit"
          ? buildAudit(key, idx)
          : buildLikert4(key, idx)

      row.appendChild(left)
      row.appendChild(right)
      itemsHost.appendChild(row)
    })
  }

  function computeTotal(root, key) {
    const def = SCALE_DEF[key]
    const rows = root.querySelectorAll(`[data-items="${key}"] .row`)
    let sum = 0
    rows.forEach((row, idx) => {
      const checked = row.querySelector(`input[name="${key}_${idx}"]:checked`)
      if (!checked) return
      sum += Number(checked.value || 0)
    })

    const totalEl = root.querySelector(`[data-total="${key}"]`)
    const noteEl = root.querySelector(`[data-note="${key}"]`)
    if (totalEl) totalEl.textContent = String(sum)
    if (noteEl) noteEl.textContent = def.note(sum)
  }

  function bindScale(root, key) {
    root.addEventListener("change", (e) => {
      const t = e.target
      if (!(t instanceof HTMLInputElement)) return
      if (!t.name.startsWith(key + "_")) return
      computeTotal(root, key)
    })
    computeTotal(root, key)
  }

  function loadVisibility() {
    try { return JSON.parse(localStorage.getItem(VIS_KEY)) || {} }
    catch (_) { return {} }
  }

  function saveVisibility(map) {
    try { localStorage.setItem(VIS_KEY, JSON.stringify(map || {})) } catch (_) {}
  }

  function setScaleVisible(hostEl, key, visible) {
    const box = hostEl.querySelector(`[data-scale="${key}"]`)
    if (!box) return
    box.style.display = visible ? "" : "none"
  }

  function renderToggles(hostEl) {
    const bar = hostEl.querySelector("[data-scale-toggles]")
    if (!bar) return
    bar.innerHTML = ""

    const vis = loadVisibility()

    Object.keys(SCALE_DEF).forEach((key) => {
      const btn = document.createElement("button")
      btn.type = "button"
      btn.className = "toggle-btn"
      btn.textContent = SCALE_DEF[key].title || key
      const visible = vis[key] !== false

      if (!visible) btn.classList.add("is-off")
      setScaleVisible(hostEl, key, visible)

      btn.addEventListener("click", () => {
        const next = btn.classList.contains("is-off")
        btn.classList.toggle("is-off", !next)
        vis[key] = next
        saveVisibility(vis)
        setScaleVisible(hostEl, key, next)
      })

      bar.appendChild(btn)
    })
  }

  function initHost(hostEl) {
    if (!hostEl) return
    if (hostEl.__scalesInited) return
    hostEl.__scalesInited = true

    const scopes = hostEl.querySelectorAll("[data-scale]")
    scopes.forEach((el) => {
      const key = el.getAttribute("data-scale")
      if (!key || !SCALE_DEF[key]) return
      renderScale(el, key)
    })
    scopes.forEach((el) => {
      const key = el.getAttribute("data-scale")
      if (!key || !SCALE_DEF[key]) return
      bindScale(hostEl, key)
    })

    renderToggles(hostEl)

    setTimeout(() => {
      scopes.forEach((el) => {
        const key = el.getAttribute("data-scale")
        if (!key || !SCALE_DEF[key]) return
        computeTotal(hostEl, key)
      })
    }, 0)
  }

  document.addEventListener("peon2:moduleMounted", (e) => {
    const detail = e && e.detail ? e.detail : {}
    if (detail.moduleId !== "module_scales") return
    initHost(detail.hostEl)
  })

  document.addEventListener("DOMContentLoaded", () => {
    const host = document.querySelector('[data-module-key="module_scales"]')
    if (host) initHost(host)
  })
})()
</script>
