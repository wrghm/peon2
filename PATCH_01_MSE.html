<!-- PATCH_01_MSE.html -->
<script>
(function () {
  const PATCH_ID = "PATCH_01_MSE_V3"

  function $(sel, root=document) { return root.querySelector(sel) }
  function $all(sel, root=document) { return Array.from(root.querySelectorAll(sel)) }

  function ensureHost() {
    return document.getElementById("modulesMount")
      || document.getElementById("modulesHost")
      || document.getElementById("ModulesHost")
      || document.body
  }

  function hideOldMse() {
    const old1 = document.getElementById("mse")
    const old2 = document.getElementById("MSE")
    if (old1) old1.style.display = "none"
    if (old2) old2.style.display = "none"
  }

  function ensureState() {
    if (!window.PEON2_STATE) window.PEON2_STATE = {}
    if (!window.PEON2_STATE.mse_v3) window.PEON2_STATE.mse_v3 = {}
    return window.PEON2_STATE.mse_v3
  }

  function setDeep(obj, path, val) {
    const parts = path.split(".")
    let cur = obj
    for (let i = 0; i < parts.length - 1; i++) {
      const k = parts[i]
      if (!cur[k] || typeof cur[k] !== "object") cur[k] = {}
      cur = cur[k]
    }
    cur[parts[parts.length - 1]] = val
  }

  function getDeep(obj, path, fallback) {
    const parts = path.split(".")
    let cur = obj
    for (const k of parts) {
      if (!cur || typeof cur !== "object" || !(k in cur)) return fallback
      cur = cur[k]
    }
    if (cur === undefined || cur === null) return fallback
    return cur
  }

  function checkboxRow(id, label) {
    return `
      <label class="mse3-row">
        <input type="checkbox" data-mse3="${id}">
        <span>${label}</span>
      </label>
    `
  }

  function textRow(path, label, placeholder) {
    return `
      <div class="mse3-row mse3-text">
        <div class="mse3-label">${label}</div>
        <input type="text" data-mse3="${path}" placeholder="${placeholder || ""}">
      </div>
    `
  }

  function render() {
    hideOldMse()

    const host = ensureHost()

    let wrap = document.getElementById("mse3")
    if (wrap) return wrap

    wrap = document.createElement("section")
    wrap.id = "mse3"
    wrap.className = "peon2-card"
    wrap.innerHTML = `
      <style>
        #mse3.peon2-card{margin:12px 0;padding:14px;border-radius:12px}
        #mse3 h2{margin:0 0 10px 0;font-size:18px}
        #mse3 h3{margin:14px 0 8px 0;font-size:14px;opacity:.9}
        #mse3 .mse3-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
        #mse3 .mse3-block{padding:10px;border-radius:10px;border:1px solid var(--border);background:rgba(0,0,0,0.02)}
        body[data-theme="dark"] #mse3 .mse3-block{background:rgba(255,255,255,0.04)}
        #mse3 .mse3-row{display:flex;align-items:flex-start;gap:8px;margin:6px 0;font-size:13px;line-height:1.3}
        #mse3 .mse3-row input[type="checkbox"]{transform:translateY(2px)}
        #mse3 .mse3-text{display:grid;grid-template-columns:160px 1fr;align-items:center;gap:10px;margin:8px 0}
        #mse3 .mse3-label{font-size:12px;opacity:.85}
        #mse3 input[type="text"]{width:100%;padding:8px 10px;border-radius:10px;border:1px solid var(--border);background:var(--card);color:var(--text);font-size:13px}
        #mse3 .mse3-actions{display:flex;flex-wrap:wrap;gap:10px;margin-top:12px}
        #mse3 button{padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:var(--card);color:var(--text);font-size:13px;cursor:pointer}
        #mse3 .mse3-output{margin-top:10px;width:100%;min-height:90px;padding:10px;border-radius:10px;border:1px dashed var(--border);background:rgba(0,0,0,0.01);font-size:13px;white-space:pre-wrap}
        body[data-theme="dark"] #mse3 .mse3-output{background:rgba(255,255,255,0.04)}
        @media (max-width:900px){#mse3 .mse3-grid{grid-template-columns:1fr}#mse3 .mse3-text{grid-template-columns:1fr}}
      </style>

      <h2>Status mentalis (MSE)</h2>

      <div class="mse3-grid">
        <div class="mse3-block">
          <h3>Kontakt i zachowanie</h3>
          ${checkboxRow("kontakt.logic","Kontakt logiczny i adekwatny")}
          ${checkboxRow("kontakt.nielogic","Kontakt utrudniony lub nielogiczny")}
          ${checkboxRow("kontakt.wspolpraca","Współpraca zachowana")}
          ${checkboxRow("kontakt.niewspolpraca","Współpraca ograniczona")}
          ${checkboxRow("zachowanie.psychomotor.spowolnienie","Spowolnienie psychoruchowe")}
          ${checkboxRow("zachowanie.psychomotor.pobudzenie","Pobudzenie psychoruchowe")}
          ${checkboxRow("zachowanie.niepokoj","Niepokój psychoruchowy")}
          ${checkboxRow("zachowanie.agresja","Zachowania agresywne")}
          ${textRow("zachowanie.inne","Inne","np. manieryzmy, stereotypie, dziwaczność, katatonia")}
        </div>

        <div class="mse3-block">
          <h3>Orientacja i świadomość</h3>
          ${checkboxRow("orientacja.auto.pelna","Orientacja autopsychiczna pełna")}
          ${checkboxRow("orientacja.auto.zaburzona","Orientacja autopsychiczna zaburzona")}
          ${checkboxRow("orientacja.allo.pelna","Orientacja allopsychiczna pełna")}
          ${checkboxRow("orientacja.allo.czesc","Orientacja allopsychiczna częściowo zaburzona")}
          ${checkboxRow("swiadomosc.przytomny","Przytomny")}
          ${checkboxRow("swiadomosc.zaburzona","Zaburzenia świadomości")}
          ${textRow("orientacja.uwagi","Uwagi","czas, miejsce, sytuacja")}
        </div>

        <div class="mse3-block">
          <h3>Mowa i tok myślenia</h3>
          ${checkboxRow("mowa.norma","Mowa prawidłowa")}
          ${checkboxRow("mowa.spowolniona","Mowa spowolniona")}
          ${checkboxRow("mowa.przyspieszona","Mowa przyspieszona")}
          ${checkboxRow("tok.logic","Tok myślenia logiczny")}
          ${checkboxRow("tok.rozkojarzenie","Rozkojarzenie lub zaburzenia kojarzenia")}
          ${checkboxRow("tok.ubogi","Ubogi tok myślenia")}
          ${checkboxRow("tok.natr","Natrętne myśli")}
          ${textRow("tok.inne","Inne","np. gonitwa myśli, lepkość, wielomówność")}
        </div>

        <div class="mse3-block">
          <h3>Nastrój i afekt</h3>
          ${textRow("afekt.nastroj","Nastrój","np. obniżony, labilny, euforyczny")}
          ${textRow("afekt.afekt","Afekt","np. spłycony, niedostosowany, napięty")}
          ${checkboxRow("afekt.anhedonia","Anhedonia")}
          ${checkboxRow("afekt.lek","Lęk")}
          ${checkboxRow("afekt.drazl","Drażliwość")}
          ${textRow("afekt.uwagi","Uwagi","jakość, zakres, kongruencja")}
        </div>

        <div class="mse3-block">
          <h3>Spostrzeganie</h3>
          ${checkboxRow("percepcja.brak","Bez objawów wytwórczych")}
          ${checkboxRow("percepcja.sluch","Omamy słuchowe")}
          ${checkboxRow("percepcja.wzrok","Omamy wzrokowe")}
          ${checkboxRow("percepcja.inne","Inne zaburzenia spostrzegania")}
          ${textRow("percepcja.opis","Opis","np. komentarze, dialogujące, sceniczne")}
        </div>

        <div class="mse3-block">
          <h3>Treści myślenia</h3>
          ${checkboxRow("tresci.uroj","Treści urojeniowe")}
          ${checkboxRow("tresci.ksob","Myśli ksobne")}
          ${checkboxRow("tresci.przesl","Myśli prześladowcze")}
          ${checkboxRow("tresci.samoos","Ruminacje samooskarżające")}
          ${checkboxRow("tresci.wielk","Treści wielkościowe")}
          ${textRow("tresci.opis","Opis","temat, stopień pewności, wpływ na zachowanie")}
        </div>

        <div class="mse3-block">
          <h3>Poznawcze</h3>
          ${checkboxRow("pozn.konc.ok","Koncentracja zachowana")}
          ${checkboxRow("pozn.konc.osl","Koncentracja osłabiona")}
          ${checkboxRow("pozn.pam.ok","Pamięć zachowana")}
          ${checkboxRow("pozn.pam.osl","Pamięć osłabiona")}
          ${checkboxRow("pozn.abstr","Zaburzenia myślenia abstrakcyjnego")}
          ${textRow("pozn.uwagi","Uwagi","uwaga, pamięć świeża, funkcje wykonawcze")}
        </div>

        <div class="mse3-block">
          <h3>Wgląd, krytycyzm, napęd</h3>
          ${checkboxRow("wglad.pel","Wgląd pełny")}
          ${checkboxRow("wglad.cz","Wgląd częściowy")}
          ${checkboxRow("wglad.br","Brak wglądu")}
          ${checkboxRow("kryt.zach","Krytycyzm zachowany")}
          ${checkboxRow("kryt.osl","Krytycyzm osłabiony")}
          ${checkboxRow("naped.osl","Napęd obniżony")}
          ${checkboxRow("naped.wzm","Napęd wzmożony")}
          ${textRow("wglad.uwagi","Uwagi","akceptacja leczenia, rozumienie objawów")}
        </div>
      </div>

      <h3>Ryzyko</h3>
      <div class="mse3-block">
        ${checkboxRow("ryz.si","Myśli samobójcze")}
        ${checkboxRow("ryz.plan","Plan samobójczy")}
        ${checkboxRow("ryz.nssi","Samouszkodzenia")}
        ${checkboxRow("ryz.hi","Myśli agresywne lub heteroagresja")}
        ${textRow("ryz.uwagi","Uwagi","ochrona, dostęp do środków, aktualna intencja")}
      </div>

      <div class="mse3-actions">
        <button type="button" id="mse3BuildShort">Generuj krótko</button>
        <button type="button" id="mse3BuildLong">Generuj szczegółowo</button>
        <button type="button" id="mse3Copy">Kopiuj</button>
      </div>

      <div id="mse3Out" class="mse3-output" contenteditable="true"></div>
    `

    host.prepend(wrap)
    return wrap
  }

  function bind() {
    const st = ensureState()
    const root = document.getElementById("mse3")
    if (!root) return

    $all("[data-mse3]", root).forEach(el => {
      const key = el.getAttribute("data-mse3")
      if (el.type === "checkbox") el.checked = !!getDeep(st, key, false)
      else el.value = getDeep(st, key, "")

      el.addEventListener("change", () => {
        if (el.type === "checkbox") setDeep(st, key, !!el.checked)
        else setDeep(st, key, String(el.value || ""))
      })
      el.addEventListener("input", () => {
        if (el.type !== "checkbox") setDeep(st, key, String(el.value || ""))
      })
    })

    $("#mse3BuildShort", root).addEventListener("click", () => {
      $("#mse3Out", root).innerText = buildText("short")
    })
    $("#mse3BuildLong", root).addEventListener("click", () => {
      $("#mse3Out", root).innerText = buildText("long")
    })
    $("#mse3Copy", root).addEventListener("click", async () => {
      const t = $("#mse3Out", root).innerText || ""
      try { await navigator.clipboard.writeText(t) } catch (_) {}
    })
  }

  function buildText(mode) {
    const st = ensureState()
    const yes = p => !!getDeep(st, p, false)
    const txt = p => String(getDeep(st, p, "") || "").trim()

    const parts = []

    function cap(s){ return s ? s.charAt(0).toUpperCase() + s.slice(1) : s }
    function sent(arr){
      if (!arr.length) return ""
      const s = cap(arr[0]) + (arr.length > 1 ? ", " + arr.slice(1).join(", ") : "")
      return s + "."
    }

    {
      const a = []
      if (yes("kontakt.logic")) a.push("kontakt logiczny i adekwatny")
      if (yes("kontakt.nielogic")) a.push("kontakt utrudniony lub nielogiczny")
      if (yes("kontakt.wspolpraca")) a.push("współpraca zachowana")
      if (yes("kontakt.niewspolpraca")) a.push("współpraca ograniczona")
      if (yes("zachowanie.psychomotor.spowolnienie")) a.push("spowolnienie psychoruchowe")
      if (yes("zachowanie.psychomotor.pobudzenie")) a.push("pobudzenie psychoruchowe")
      if (yes("zachowanie.niepokoj")) a.push("niepokój psychoruchowy")
      if (yes("zachowanie.agresja")) a.push("zachowania agresywne")
      const other = txt("zachowanie.inne")
      if (other) a.push(other)
      const s = sent(a)
      if (s) parts.push(s)
    }

    {
      const a = []
      if (yes("swiadomosc.przytomny")) a.push("przytomny")
      if (yes("swiadomosc.zaburzona")) a.push("zaburzenia świadomości")
      if (yes("orientacja.auto.pelna")) a.push("orientacja autopsychiczna pełna")
      if (yes("orientacja.auto.zaburzona")) a.push("orientacja autopsychiczna zaburzona")
      if (yes("orientacja.allo.pelna")) a.push("orientacja allopsychiczna pełna")
      if (yes("orientacja.allo.czesc")) a.push("orientacja allopsychiczna częściowo zaburzona")
      const uw = txt("orientacja.uwagi")
      if (uw) a.push("uwagi: " + uw)
      const s = sent(a)
      if (s) parts.push(s)
    }

    {
      const a = []
      if (yes("mowa.norma")) a.push("mowa prawidłowa")
      if (yes("mowa.spowolniona")) a.push("mowa spowolniona")
      if (yes("mowa.przyspieszona")) a.push("mowa przyspieszona")
      if (yes("tok.logic")) a.push("tok myślenia logiczny")
      if (yes("tok.rozkojarzenie")) a.push("zaburzenia kojarzenia")
      if (yes("tok.ubogi")) a.push("ubogi tok myślenia")
      if (yes("tok.natr")) a.push("natrętne myśli")
      const other = txt("tok.inne")
      if (other) a.push(other)
      const s = sent(a)
      if (s) parts.push(s)
    }

    {
      const a = []
      const n = txt("afekt.nastroj")
      if (n) a.push("nastrój: " + n)
      const af = txt("afekt.afekt")
      if (af) a.push("afekt: " + af)
      if (yes("afekt.anhedonia")) a.push("anhedonia")
      if (yes("afekt.lek")) a.push("lęk")
      if (yes("afekt.drazl")) a.push("drażliwość")
      const uw = txt("afekt.uwagi")
      if (uw) a.push("uwagi: " + uw)
      const s = sent(a)
      if (s) parts.push(s)
    }

    {
      const a = []
      if (yes("percepcja.brak")) a.push("bez objawów wytwórczych")
      if (yes("percepcja.sluch")) a.push("omamy słuchowe")
      if (yes("percepcja.wzrok")) a.push("omamy wzrokowe")
      if (yes("percepcja.inne")) a.push("inne zaburzenia spostrzegania")
      const op = txt("percepcja.opis")
      if (op) a.push("opis: " + op)
      const s = sent(a)
      if (s) parts.push(s)
    }

    {
      const a = []
      if (yes("tresci.uroj")) a.push("treści urojeniowe")
      if (yes("tresci.ksob")) a.push("myśli ksobne")
      if (yes("tresci.przesl")) a.push("myśli prześladowcze")
      if (yes("tresci.samoos")) a.push("ruminacje samooskarżające")
      if (yes("tresci.wielk")) a.push("treści wielkościowe")
      const op = txt("tresci.opis")
      if (op) a.push("opis: " + op)
      const s = sent(a)
      if (s) parts.push(s)
    }

    {
      const a = []
      if (yes("pozn.konc.ok")) a.push("koncentracja zachowana")
      if (yes("pozn.konc.osl")) a.push("koncentracja osłabiona")
      if (yes("pozn.pam.ok")) a.push("pamięć zachowana")
      if (yes("pozn.pam.osl")) a.push("pamięć osłabiona")
      if (yes("pozn.abstr")) a.push("zaburzenia myślenia abstrakcyjnego")
      const uw = txt("pozn.uwagi")
      if (uw) a.push("uwagi: " + uw)
      const s = sent(a)
      if (s) parts.push(s)
    }

    {
      const a = []
      if (yes("wglad.pel")) a.push("wgląd pełny")
      if (yes("wglad.cz")) a.push("wgląd częściowy")
      if (yes("wglad.br")) a.push("brak wglądu")
      if (yes("kryt.zach")) a.push("krytycyzm zachowany")
      if (yes("kryt.osl")) a.push("krytycyzm osłabiony")
      if (yes("naped.osl")) a.push("napęd obniżony")
      if (yes("naped.wzm")) a.push("napęd wzmożony")
      const uw = txt("wglad.uwagi")
      if (uw) a.push("uwagi: " + uw)
      const s = sent(a)
      if (s) parts.push(s)
    }

    {
      const a = []
      if (yes("ryz.si")) a.push("myśli samobójcze")
      if (yes("ryz.plan")) a.push("plan samobójczy")
      if (yes("ryz.nssi")) a.push("autoagresja")
      if (yes("ryz.hi")) a.push("ryzyko heteroagresji")
      const uw = txt("ryz.uwagi")
      if (uw) a.push("uwagi: " + uw)

      if (a.length) parts.push("Ryzyko: " + a.join(", ") + ".")
      else parts.push("Ryzyko: nie zgłasza myśli samobójczych, nie zgłasza zamiarów agresywnych.")
    }

    if (mode === "short") return parts.slice(0, 7).join("\n")
    return parts.join("\n")
  }

  function applyPatch() {
    window.PEON2_PATCHER.register({
      id: PATCH_ID,
      apply: () => { render(); bind() }
    })
  }

  (function waitForPatcher() {
    let i = 0
    const max = 80
    const t = setInterval(() => {
      i++
      if (window.PEON2_PATCHER && typeof window.PEON2_PATCHER.register === "function") {
        clearInterval(t)
        applyPatch()
      }
      if (i >= max) clearInterval(t)
    }, 50)
  })()
})()
</script>
<!-- PATCH_01_MSE_V3_GUARD -->
